{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://raw.githubusercontent.com/microsoft/MLOS/main/mlos_bench/mlos_bench/config/schemas/optimizers/optimizer-schema.json",
    "title": "mlos_bench Optimizer config",

    "$defs": {
        "$comment": "reusable partial schema bits",

        "config_base_optimizer": {
            "$comment": "config properties common to all optimizer types.",
            "type": "object",
            "properties": {
                "minimize": {
                    "description": "The name of the metric to minimize.",
                    "$comment": "In oneOf spec below require one of 'minimize' or 'maximize'.",
                    "type": "string"
                },
                "maximize": {
                    "description": "The name of the metric to maximize.",
                    "$comment": "In oneOf spec below require one of 'minimize' or 'maximize'.",
                    "type": "string"
                },
                "max_iterations": {
                    "description": "The maximum number of iterations to run.",
                    "type": "integer",
                    "minimum": 0
                },
                "seed": {
                    "description": "The seed to use for the random number generator.",
                    "type": "integer"
                },
                "use_defaults": {
                    "description": "Whether to use the ConfigSpace defaults for the first iteration of the optimizer.",
                    "type": "boolean"
                }
            },
            "oneOf": [
                {
                    "required": ["minimize"]
                },
                {
                    "required": ["maximize"]
                }
            ]
        },

        "config_tunable_values_optimizer": {
            "$comment": "Properties specific to optimizers that allow a specific set of tunable values to be used.",
            "type": "object",
            "properties": {
                "include_tunable_values": {
                    "$comment": "Optional list of file paths with tunable values to include in the optimization.",
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "[.]json[c]?$"
                    }
                },
                "tunable_values": {
                    "$comment": "Optional list of dictionaries of tunable values to include in the optimization.",
                    "type": "array",
                    "items": {
                        "type": "object"
                    }
                }
            }
        }
    },

    "description": "config for the mlos_bench optimizer",
    "$comment": "top level schema document rules",
    "type": "object",
    "properties": {
        "$schema": {
            "description": "The schema to use for validating the optimizer config (accepts both URLs and local paths).",
            "type": "string",
            "$comment": "This is optional, but if provided, should match the name of this file.",
            "pattern": "schemas/optimizers/optimizer-schema.json$"
        },

        "description": {
            "description": "Optional description of the config.",
            "type": "string"
        },

        "class": {
            "description": "The name of the optimizer class to use.",
            "$comment": "required",
            "enum": [
                "mlos_bench.optimizers.MlosCoreOptimizer",
                "mlos_bench.optimizers.MockOptimizer",
                "mlos_bench.optimizers.OneShotOptimizer"
            ]
        },

        "include_tunables": {
            "description": "A list of file paths containing tunable parameters definitions to include in the optimization.",
            "type": "array",
            "items": {
                "type": "string",
                "$comment": "Paths are expected to be json.",
                "pattern": "[.]json[c]?$"
            }
        },

        "config": {
            "description": "The optimizer specific config.",
            "$comment": "Stub for optimizer specific config appended with condition statements below",
            "type": "object"
        }
    },
    "required": ["class"],

    "oneOf": [
        {
            "$comment": "Extensions to the allowed 'config' object properties when the optimizer is the mlos_core optimizer.",
            "if": {
                "properties": {
                    "class": {
                        "const": "mlos_bench.optimizers.MlosCoreOptimizer"
                    }
                },
                "required": ["class"]
            },
            "then": {
                "properties": {
                    "config": {
                        "type": "object",
                        "allOf": [
                            {
                                "$comment": "Allow all base optimizer configs",
                                "$ref": "#/$defs/config_base_optimizer"
                            },
                            {
                                "$comment": "Extend with properties specific to the mlos_core optimizer type.",
                                "type": "object",
                                "properties": {
                                    "optimizer_type": {
                                        "description": "The underlying optimizer type to use.",
                                        "$comment": "See Also: mlos_core/optimizers/__init__.py",
                                        "enum": [null, "SKOPT", "EMUKIT", "RANDOM"]
                                    },
                                    "space_adapter_type": {
                                        "description": "The type of space adapter to use.",
                                        "$comment": "See Also: mlos_core/spaces/__init__.py",
                                        "enum": [null, "IDENTITY", "LLAMATUNE"]
                                    },
                                    "space_adapter_config": {
                                        "description": "The space adapter specific config.",
                                        "$comment": "stub for possible space adapter configs based on type (set using conditionals below)",
                                        "type": "object"
                                    }
                                },
                                "allOf": [
                                    {
                                        "$comment": "add extra recognized params for SKOPT optimizer type",
                                        "if": {
                                            "properties": {
                                                "optimizer_type": {
                                                    "const": "SKOPT"
                                                }
                                            },
                                            "required": ["optimizer_type"]
                                        },
                                        "then": {
                                            "properties": {
                                                "base_estimator": {
                                                    "description": "The base estimator to use for the SKOPT optimizer.",
                                                    "enum": ["gp", "et"]
                                                }
                                            }
                                        }
                                    },
                                    {
                                        "$comment": "a set of rules for the space adapter schema extensions",
                                        "oneOf": [
                                            {
                                                "if": {
                                                    "$comment": "disallow any extra space_adapter_configs for IDENTITY/null space_adapter_type",
                                                    "anyOf": [
                                                        {
                                                            "properties": {
                                                                "space_adapter_type": {
                                                                    "const": null
                                                                }
                                                            },
                                                            "required": ["space_adapter_type"]
                                                        },
                                                        {
                                                            "properties": {
                                                                "space_adapter_type": {
                                                                    "const": "IDENTITY"
                                                                }
                                                            },
                                                            "required": ["space_adapter_type"]
                                                        },
                                                        {
                                                            "$comment": "Match when space_adapter_type is not present",
                                                            "not": {
                                                                "required": ["space_adapter_type"]
                                                            }
                                                        }
                                                    ]
                                                },
                                                "then": {
                                                    "not": {
                                                        "$comment": "space_adapter_config should be omitted in this case",
                                                        "required": ["space_adapter_config"]
                                                    }
                                                },
                                                "else": false
                                            },
                                            {
                                                "if": {
                                                    "properties": {
                                                        "space_adapter_type": {
                                                            "const": "LLAMATUNE"
                                                        }
                                                    },
                                                    "required": ["space_adapter_type"]
                                                },
                                                "then": {
                                                    "properties": {
                                                        "space_adapter_config": {
                                                            "$comment": "Properties specific to the llamatune space adapter config.",
                                                            "type": "object",
                                                            "properties": {
                                                                "num_low_dims": {
                                                                    "description": "Number of dimensions used in the low-dimensional parameter search space.",
                                                                    "type": "integer",
                                                                    "minimum": 2
                                                                },
                                                                "special_param_values": {
                                                                    "type": "object"
                                                                },
                                                                "max_unique_values_per_param": {
                                                                    "type": "integer",
                                                                    "minimum": 1
                                                                }
                                                            },
                                                            "unevaluatedProperties": false
                                                        }
                                                    }
                                                },
                                                "else": false
                                            }
                                        ]
                                    }
                                ]
                            }
                        ],
                        "unevaluatedProperties": false
                    }
                },
                "$comment": "Set 'else' to false to prevent it to defaulting to a valid document match."
            },
            "else": false
        },

        {
            "$comment": "extensions to the 'config' object properties when the mock optimizer is being used",
            "if": {
                "properties": {
                    "class": {
                        "const": "mlos_bench.optimizers.MockOptimizer"
                    }
                },
                "required": ["class"]
            },
            "then": {
                "properties": {
                    "config": {
                        "type": "object",
                        "allOf": [{ "$ref": "#/$defs/config_base_optimizer" }],
                        "$comment": "disallow other properties",
                        "unevaluatedProperties": false
                    }
                }
            },
            "else": false
        },

        {
            "$comment": "extensions to the 'config' object properties when the one shot optimizer is being used",
            "if": {
                "properties": {
                    "class": {
                        "const": "mlos_bench.optimizers.OneShotOptimizer"
                    }
                },
                "required": ["class"]
            },
            "then": {
                "properties": {
                    "config": {
                        "type": "object",
                        "allOf": [
                            { "$ref": "#/$defs/config_base_optimizer" },
                            { "$ref": "#/$defs/config_tunable_values_optimizer" }
                        ],
                        "unevaluatedProperties": false
                    }
                }
            },
            "else": false
        }
    ],
    "unevaluatedProperties": false
}
